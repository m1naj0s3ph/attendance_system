<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù…Ø§Ø³Ø­ Ø§Ù„Ø¶ÙˆØ¦ÙŠ - Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¶ÙˆØ±</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Tajawal', sans-serif;
            min-height: 100vh;
            padding: 20px;
            color: white;
        }
        .scanner-container {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-width: 500px;
            margin: 0 auto;
            color: #333;
        }
        #reader {
            width: 100%;
            margin: 20px 0;
            border-radius: 10px;
            overflow: hidden;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            position: relative;
        }
        #status {
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin: 15px 0;
            font-weight: bold;
        }
        .status-connected { background: #d4edda; color: #155724; }
        .status-disconnected { background: #f8d7da; color: #721c24; }
        .status-scanning { background: #fff3cd; color: #856404; }
        .status-error { background: #f8d7da; color: #721c24; }
        .status-warning { background: #fff3cd; color: #856404; }
        
        .manual-input {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        .scanner-overlay {
            position: relative;
            border: 3px solid #25D366;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }
        .camera-permission {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
        }
        .camera-fallback {
            background: #e9ecef;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin: 10px 0;
        }
        .browser-support {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }
        .camera-guide {
            background: #e2e3e5;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="scanner-container">
        <div class="text-center mb-4">
            <h2><i class="fas fa-camera"></i> Ø§Ù„Ù…Ø§Ø³Ø­ Ø§Ù„Ø¶ÙˆØ¦ÙŠ</h2>
            <p class="text-muted">ÙˆØ¬Ù‡ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù†Ø­Ùˆ ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨</p>
        </div>

        <div id="status" class="status-disconnected">
            <i class="fas fa-plug"></i> Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…...
        </div>

        <!-- Ø¯Ù„ÙŠÙ„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ -->
        <div class="camera-guide">
            <h6><i class="fas fa-info-circle"></i> Ù†ØµØ§Ø¦Ø­ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§:</h6>
            <ul class="mb-0">
                <li>Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø®Ù„ÙÙŠØ© (Ø°Ø§Øª Ø§Ù„Ø¬ÙˆØ¯Ø© Ø§Ù„Ø£Ø¹Ù„Ù‰)</li>
                <li>ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¶Ø§Ø¡Ø© Ø¬ÙŠØ¯Ø©</li>
                <li>Ø£Ø¨Ø¹Ø¯ Ø§Ù„Ù‡Ø§ØªÙ Ù…Ø³Ø§ÙØ© 15-20 Ø³Ù… Ø¹Ù† Ø§Ù„ÙƒÙˆØ¯</li>
            </ul>
        </div>

        <!-- Ø±Ø³Ø§Ù„Ø© Ø¯Ø¹Ù… Ø§Ù„Ù…ØªØµÙØ­ -->
        <div class="browser-support" id="browserSupport" style="display: none;">
            <h6><i class="fas fa-exclamation-triangle"></i> Ù…Ù„Ø§Ø­Ø¸Ø© Ù‡Ø§Ù…Ø©:</h6>
            <p class="mb-2">Ù„Ø£ÙØ¶Ù„ Ø£Ø¯Ø§Ø¡ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø£Ø­Ø¯Ø« Ø¥ØµØ¯Ø§Ø± Ù…Ù†:</p>
            <div class="d-flex justify-content-around">
                <span class="badge bg-success">Chrome</span>
                <span class="badge bg-primary">Firefox</span>
                <span class="badge bg-info">Safari</span>
            </div>
        </div>

        <!-- Ø±Ø³Ø§Ù„Ø© Ø¥Ø°Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ -->
        <div class="camera-permission" id="cameraPermission" style="display: none;">
            <i class="fas fa-camera fa-2x mb-2"></i>
            <h5>Ø§Ù„Ø¥Ø°Ù† Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</h5>
            <p>ÙŠØ­ØªØ§Ø¬ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¥Ù„Ù‰ Ø¥Ø°Ù† Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù„Ù„Ù…Ø³Ø­</p>
            <div class="d-grid gap-2">
                <button class="btn btn-primary" onclick="requestCameraPermission()">
                    <i class="fas fa-camera"></i> Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
                </button>
                <button class="btn btn-outline-secondary" onclick="showManualInput()">
                    <i class="fas fa-keyboard"></i> Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠ
                </button>
            </div>
        </div>

        <!-- Ø¨Ø¯ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ -->
        <div class="camera-fallback" id="cameraFallback" style="display: none;">
            <i class="fas fa-camera-slash fa-2x mb-2"></i>
            <h5>Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØºÙŠØ± Ù…ØªØ§Ø­Ø©</h5>
            <p>ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠ Ø£Ø¯Ù†Ø§Ù‡</p>
            <button class="btn btn-secondary" onclick="showManualInput()">
                <i class="fas fa-keyboard"></i> ÙØªØ­ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠ
            </button>
        </div>

        <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø§Ø³Ø­ -->
        <div class="scanner-overlay">
            <div id="reader">
                <div id="cameraPlaceholder" class="text-center p-4">
                    <i class="fas fa-camera fa-3x text-muted mb-3"></i>
                    <p class="text-muted">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§...</p>
                </div>
            </div>
        </div>

        <!-- Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠ -->
        <div class="manual-input" id="manualInput" style="display: none;">
            <h5><i class="fas fa-keyboard"></i> Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠ</h5>
            <div class="input-group mb-3">
                <input type="text" id="studentId" class="form-control" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨" autocomplete="off">
                <button class="btn btn-primary" onclick="sendStudentId()">
                    <i class="fas fa-paper-plane"></i> Ø¥Ø±Ø³Ø§Ù„
                </button>
            </div>
            <small class="text-muted">Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø«Ù… Ø§Ù†Ù‚Ø± Ø¥Ø±Ø³Ø§Ù„</small>
        </div>

        <div class="mt-4 text-center">
            <div id="lastScan" class="text-muted small"></div>
            <div class="mt-2">
                <small class="text-muted">
                    <i class="fas fa-info-circle"></i>
                    Ø³ÙŠØªÙ… ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø² Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±
                </small>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
    <script>
        let html5QrcodeScanner = null;
        let lastScanned = '';
        let isCameraActive = false;
        let scanAttempts = 0;
        const MAX_SCAN_ATTEMPTS = 3;

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¯Ø¹Ù… Ø§Ù„Ù…ØªØµÙØ­
        function checkBrowserSupport() {
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const isChrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
            const isSafari = /Safari/.test(navigator.userAgent) && /Apple Computer/.test(navigator.vendor);
            const isFirefox = /Firefox/.test(navigator.userAgent);
            
            if (!isMobile) {
                document.getElementById('browserSupport').style.display = 'block';
            }
            
            if (!isChrome && !isSafari && !isFirefox) {
                document.getElementById('status').className = 'status-warning';
                document.getElementById('status').innerHTML = 
                    '<i class="fas fa-exclamation-triangle"></i> Ø§Ù„Ù…ØªØµÙØ­ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… Ø¨Ø´ÙƒÙ„ ÙƒØ§Ù…Ù„ - Ø¬Ø±Ø¨ Chrome Ø£Ùˆ Safari';
            }
            
            return !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
        }

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
        function initializeCamera() {
            if (scanAttempts >= MAX_SCAN_ATTEMPTS) {
                showCameraFallback();
                return;
            }

            scanAttempts++;
            
            // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
            initScanner();
        }

        // Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
        function requestCameraPermission() {
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø£ÙˆÙ„Ø§Ù‹
            const constraints = {
                video: {
                    facingMode: { ideal: "environment" }, // Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø®Ù„ÙÙŠØ©
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            };

            navigator.mediaDevices.getUserMedia(constraints)
                .then(function(stream) {
                    // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙÙˆØ±Ø§Ù‹ Ø¨Ø¹Ø¯ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø°Ù†
                    stream.getTracks().forEach(track => track.stop());
                    document.getElementById('cameraPermission').style.display = 'none';
                    initScanner();
                })
                .catch(function(err) {
                    console.error("âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¥Ø°Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§:", err);
                    
                    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ© ÙƒØ¨Ø¯ÙŠÙ„
                    const frontConstraints = {
                        video: {
                            facingMode: "user", // Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ©
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }
                    };
                    
                    navigator.mediaDevices.getUserMedia(frontConstraints)
                        .then(function(stream) {
                            stream.getTracks().forEach(track => track.stop());
                            document.getElementById('cameraPermission').style.display = 'none';
                            initScanner();
                        })
                        .catch(function(err2) {
                            console.error("âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¥Ø°Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ©:", err2);
                            showCameraFallback();
                        });
                });
        }

        // Ø¹Ø±Ø¶ Ø¨Ø¯ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
        function showCameraFallback() {
            document.getElementById('cameraFallback').style.display = 'block';
            document.getElementById('cameraPermission').style.display = 'none';
            document.getElementById('status').className = 'status-error';
            document.getElementById('status').innerHTML = 
                '<i class="fas fa-camera-slash"></i> Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØºÙŠØ± Ù…ØªØ§Ø­Ø© - Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠ';
            showManualInput();
        }

        // Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠ
        function showManualInput() {
            document.getElementById('manualInput').style.display = 'block';
            document.getElementById('studentId').focus();
        }

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø§Ø³Ø­ Ø§Ù„Ø¶ÙˆØ¦ÙŠ
        function initScanner() {
            if (isCameraActive) return;

            try {
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… HTML5 QR Code Scanner
                html5QrcodeScanner = new Html5QrcodeScanner(
                    "reader", 
                    { 
                        fps: 10, 
                        qrbox: { width: 250, height: 250 },
                        aspectRatio: 1.0,
                        supportedScanTypes: [
                            Html5QrcodeScanType.SCAN_TYPE_QR_CODE,
                            Html5QrcodeScanType.SCAN_TYPE_CAMERA
                        ]
                    },
                    false
                );

                html5QrcodeScanner.render(
                    onScanSuccess,
                    onScanFailure
                ).then(() => {
                    isCameraActive = true;
                    scanAttempts = 0; // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª
                    document.getElementById('status').className = 'status-connected';
                    document.getElementById('status').innerHTML = '<i class="fas fa-camera"></i> Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¬Ø§Ù‡Ø²Ø© - Ø§Ù…Ø³Ø­ Ø§Ù„ÙƒÙˆØ¯';
                    document.getElementById('cameraPermission').style.display = 'none';
                    document.getElementById('cameraFallback').style.display = 'none';
                    document.getElementById('cameraPlaceholder').style.display = 'none';
                }).catch(err => {
                    console.error("âŒ ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø§Ø³Ø­:", err);
                    handleCameraError(err);
                });
            } catch (error) {
                console.error("âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø§Ø³Ø­:", error);
                handleCameraError(error);
            }
        }

        // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
        function handleCameraError(error) {
            console.error("ğŸ”§ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£:", error);
            
            if (error.name === 'NotAllowedError') {
                document.getElementById('cameraPermission').style.display = 'block';
                document.getElementById('status').className = 'status-warning';
                document.getElementById('status').innerHTML = 
                    '<i class="fas fa-exclamation-triangle"></i> ÙŠÙ„Ø²Ù… Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§';
            } else if (error.name === 'NotFoundError' || error.name === 'OverconstrainedError') {
                showCameraFallback();
            } else if (error.name === 'NotSupportedError') {
                document.getElementById('status').className = 'status-error';
                document.getElementById('status').innerHTML = 
                    '<i class="fas fa-exclamation-triangle"></i> Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§';
                showCameraFallback();
            } else {
                document.getElementById('status').className = 'status-error';
                document.getElementById('status').innerHTML = 
                    '<i class="fas fa-exclamation-triangle"></i> Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ ÙÙŠ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§';
                
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¨Ø¹Ø¯ ØªØ£Ø®ÙŠØ±
                setTimeout(() => {
                    if (scanAttempts < MAX_SCAN_ATTEMPTS) {
                        initializeCamera();
                    } else {
                        showCameraFallback();
                    }
                }, 2000);
            }
        }

        // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø§Ø³Ø­
        function stopScanner() {
            if (html5QrcodeScanner && isCameraActive) {
                html5QrcodeScanner.clear().then(() => {
                    isCameraActive = false;
                    console.log("âœ… ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø§Ø³Ø­ Ø§Ù„Ø¶ÙˆØ¦ÙŠ");
                }).catch(err => {
                    console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø§Ø³Ø­:", err);
                });
            }
        }

        // Ø¹Ù†Ø¯ Ø§Ù„Ù…Ø³Ø­ Ø§Ù„Ù†Ø§Ø¬Ø­
        function onScanSuccess(decodedText) {
            if (decodedText === lastScanned) return; // Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±
            
            lastScanned = decodedText;
            
            // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· (Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø±Ø§Ø¨Ø· ÙƒØ§Ù…Ù„Ø§Ù‹)
            let studentId = decodedText;
            if (decodedText.includes('/student/')) {
                studentId = decodedText.split('/student/')[1];
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨
            if (!isValidStudentId(studentId)) {
                console.warn("âš ï¸  Ø±Ù‚Ù… Ø·Ø§Ù„Ø¨ ØºÙŠØ± ØµØ§Ù„Ø­:", studentId);
                return;
            }
            
            document.getElementById('status').className = 'status-scanning';
            document.getElementById('status').innerHTML = `<i class="fas fa-sync fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ ${studentId}...`;
            
            sendStudentToServer(studentId);
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨
        function isValidStudentId(studentId) {
            return studentId && studentId.length > 0 && /^[a-zA-Z0-9\-_]+$/.test(studentId);
        }

        // Ø¹Ù†Ø¯ ÙØ´Ù„ Ø§Ù„Ù…Ø³Ø­
        function onScanFailure(error) {
            // ØªØ¬Ø§Ù‡Ù„ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù…Ø³Ø­ Ø§Ù„Ù…Ø³ØªÙ…Ø±Ø© (Ù‡Ø°Ù‡ Ø·Ø¨ÙŠØ¹ÙŠØ©)
        }

        // Ø¥Ø±Ø³Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù…
        function sendStudentToServer(studentId) {
            // Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ AJAX Ù„Ø¥Ø±Ø³Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨
            fetch('/direct_scan', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `student_id=${encodeURIComponent(studentId)}`
            })
            .then(response => {
                if (response.ok) {
                    // Ø¥ØµØ¯Ø§Ø± ØµÙˆØª Ù„Ù„Ù…Ø³Ø­ Ø§Ù„Ù†Ø§Ø¬Ø­
                    playBeepSound();
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                    document.getElementById('lastScan').innerHTML = 
                        `<i class="fas fa-check"></i> Ø¢Ø®Ø± Ù…Ø³Ø­: ${studentId} - ${new Date().toLocaleTimeString()}`;
                    
                    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØ©
                    setTimeout(() => {
                        if (isCameraActive) {
                            document.getElementById('status').className = 'status-connected';
                            document.getElementById('status').innerHTML = '<i class="fas fa-camera"></i> Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¬Ø§Ù‡Ø²Ø© - Ø§Ù…Ø³Ø­ Ø§Ù„ÙƒÙˆØ¯';
                        }
                    }, 2000);
                }
            })
            .catch(error => {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
            });
        }

        // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ù„Ù„Ù…Ø³Ø­ Ø§Ù„Ù†Ø§Ø¬Ø­
        function playBeepSound() {
            try {
                // Ø¥Ù†Ø´Ø§Ø¡ ØµÙˆØª Ø¨Ø³ÙŠØ· Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Web Audio API
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (e) {
                // ØªØ¬Ø§Ù‡Ù„ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„ØµÙˆØª
            }
        }

        // Ø¥Ø±Ø³Ø§Ù„ Ù…Ù† Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠ
        function sendStudentId() {
            const studentId = document.getElementById('studentId').value.trim();
            if (!studentId) {
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨');
                return;
            }
            
            if (!isValidStudentId(studentId)) {
                alert('Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± ØµØ§Ù„Ø­');
                return;
            }
            
            document.getElementById('studentId').value = '';
            sendStudentToServer(studentId);
        }

        // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        document.addEventListener('DOMContentLoaded', function() {
            // Ø¥Ø¸Ù‡Ø§Ø± Ø¯Ø¹Ù… Ø§Ù„Ù…ØªØµÙØ­
            checkBrowserSupport();
            
            // Ø¥Ø±Ø³Ø§Ù„ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter
            document.getElementById('studentId').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendStudentId();
                }
            });

            // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
            setTimeout(initializeCamera, 1000);
        });

        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø§Ø³Ø­ Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø©
        window.addEventListener('beforeunload', function() {
            stopScanner();
        });

        // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                // Ø§Ù„ØµÙØ­Ø© ØºÙŠØ± Ù…Ø±Ø¦ÙŠØ© - Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ©
                stopScanner();
            } else {
                // Ø§Ù„ØµÙØ­Ø© Ù…Ø±Ø¦ÙŠØ© - Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
                setTimeout(() => {
                    if (!isCameraActive) {
                        initializeCamera();
                    }
                }, 500);
            }
        });
    </script>
</body>
</html>